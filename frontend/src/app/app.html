<div class="container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <span class="icon">ğŸ¨</span>
      <h2>Harriot Experience</h2>
    </div>

    <div class="controls">
      <h3>Traveler Context Simulator</h3>
      <p class="subtitle">Simulate guest arrival</p>

      <div class="tab-nav">
        <button [class.active]="activeTab === 'simulation'" (click)="activeTab = 'simulation'">Simulation</button>
        <button [class.active]="activeTab === 'pricing'" (click)="activeTab = 'pricing'">Pricing</button>
        <button [class.active]="activeTab === 'campaigns'" (click)="activeTab = 'campaigns'">Campaigns</button>
      </div>

      <div class="form-group" *ngIf="activeTab === 'simulation'">
        <label>Age</label>
        <input type="range" min="18" max="90" [(ngModel)]="profile.age" (change)="onProfileChange()">
        <span class="value">{{profile.age}}</span>
      </div>

      <div class="form-group" *ngIf="activeTab === 'simulation'">
        <label>Loyalty Tier</label>
        <select [(ngModel)]="profile.loyalty_tier" (change)="onProfileChange()">
          <option *ngFor="let t of tiers" [value]="t">{{t}}</option>
        </select>
      </div>

      <div class="form-group" *ngIf="activeTab === 'simulation'">
        <label>Avg Spend ($)</label>
        <input type="number" [(ngModel)]="profile.avg_spend" (change)="onProfileChange()">
      </div>

      <div class="form-group" *ngIf="activeTab === 'simulation'">
        <label>Days Since Last Stay</label>
        <input type="number" [(ngModel)]="profile.last_stay_days_ago" (change)="onProfileChange()">
      </div>

      <div class="form-group" *ngIf="activeTab === 'simulation'">
        <label>Trip Purpose</label>
        <div class="radio-group">
          <label *ngFor="let p of purposes">
            <input type="radio" name="purpose" [value]="p" [(ngModel)]="profile.travel_purpose"
              (change)="onProfileChange()"> {{p}}
          </label>
        </div>
      </div>

      <div class="form-group" *ngIf="activeTab === 'simulation'">
        <label>Known Preferences</label>
        <div class="checkbox-group">
          <label *ngFor="let a of amenitiesList">
            <input type="checkbox" [checked]="isAmenitySelected(a)" (change)="toggleAmenity(a, $event)"> {{a}}
          </label>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="content">
    <header>
      <h1>Intelligent Experience Engine</h1>
      <div class="status-badge">AI Online ğŸŸ¢</div>
    </header>

    <!-- Analytics Dashboard -->
    <section class="dashboard" *ngIf="prediction">
      <div class="card metric-card">
        <div class="label">Predicted Micro-Segment</div>
        <div class="value highlight">{{prediction.segment_label}}</div>
        <div class="desc">Based on behavior & spend</div>
      </div>

      <div class="card metric-card">
        <div class="label">Conversion Probability</div>
        <div class="value">{{prediction.booking_probability | percent:'1.0-1'}}</div>
        <div class="desc"
          [ngClass]="{'high': prediction.booking_probability > 0.7, 'med': prediction.booking_probability > 0.4}">
          {{prediction.booking_probability > 0.7 ? 'High Potential' : 'Medium Potential'}}
        </div>
      </div>

      <div class="card metric-card">
        <div class="label">Est. Lifetime Value</div>
        <div class="value">${{prediction.estimated_ltv | number:'1.0-0'}}</div>
        <div class="desc">Yearly Projection</div>
      </div>
    </section>

    <div class="loading" *ngIf="loadingPrediction">Analyzing profile...</div>

    <!-- Offer Engine -->
    <section class="offer-engine" *ngIf="prediction">
      <div class="divider"></div>
      <h2>ğŸ’¡ Dynamic Offer Generation</h2>

      <button class="generate-btn" (click)="generateOffer()" [disabled]="loadingOffer">
        {{ loadingOffer ? 'Crafting Offer...' : 'Generate Personalized Offer' }}
      </button>

      <div class="offer-result fade-in" *ngIf="offer">
        <div class="offer-image">
          <img
            src="https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80"
            alt="Luxury Hotel">
        </div>
        <div class="offer-details">
          <h3>âœ¨ {{offer.offer_name}}</h3>
          <blockquote class="copy">
            "{{offer.copy}}"
          </blockquote>
          <div class="offer-meta">
            <span>Targeting <strong>{{prediction.segment_label}}</strong></span>
            <span>Boost: <strong>+15%</strong> Conversion</span>
          </div>
          <button class="send-btn">Send to Guest App ğŸ“±</button>
        </div>
      </div>
    </section>
    <!-- Event-Based Dynamic Pricing -->
    <section class="event-pricing-section">
      <div class="divider"></div>
      <h2>ğŸ­ Event-Based Dynamic Pricing</h2>
      <p class="subtitle">Optimize rates based on local events and concerts</p>

      <div class="pricing-controls">
        <div class="form-row">
          <div class="form-group">
            <label>City</label>
            <select [(ngModel)]="eventPricingForm.city" (change)="onEventPricingFormChange()">
              <option *ngFor="let city of cities" [value]="city">{{city}}</option>
            </select>
          </div>

          <div class="form-group">
            <label>Check-in Date</label>
            <input type="date" [(ngModel)]="eventPricingForm.check_in_date" (change)="onEventPricingFormChange()">
          </div>

          <div class="form-group">
            <label>Check-out Date</label>
            <input type="date" [(ngModel)]="eventPricingForm.check_out_date" (change)="onEventPricingFormChange()">
          </div>

          <div class="form-group">
            <label>Base Rate ($)</label>
            <input type="number" [(ngModel)]="eventPricingForm.base_room_rate" (change)="onEventPricingFormChange()">
          </div>
        </div>
      </div>

      <div class="loading" *ngIf="loadingEventPricing">Analyzing local events...</div>

      <!-- Pricing Results -->
      <div class="pricing-results" *ngIf="eventPricing && !loadingEventPricing">
        <div class="pricing-cards">
          <div class="card pricing-card">
            <div class="label">Original Rate</div>
            <div class="value">${{eventPricing.original_rate}}</div>
            <div class="desc">Base room rate</div>
          </div>

          <div class="card pricing-card highlight">
            <div class="label">Optimized Rate</div>
            <div class="value">${{eventPricing.adjusted_rate}}</div>
            <div class="desc"
              [ngClass]="{'positive': getPriceChangePercentage() > 0, 'negative': getPriceChangePercentage() < 0}">
              {{getPriceChangePercentage() > 0 ? '+' : ''}}{{getPriceChangePercentage() | number:'1.1-1'}}% change
            </div>
          </div>

          <div class="card pricing-card">
            <div class="label">Price Multiplier</div>
            <div class="value">{{eventPricing.multiplier}}x</div>
            <div class="desc">{{eventPricing.events_count}} events detected</div>
          </div>

          <div class="card pricing-card">
            <div class="label">Confidence Score</div>
            <div class="value">{{eventPricing.confidence_score * 100 | number:'1.0-0'}}%</div>
            <div class="desc">AI prediction accuracy</div>
          </div>
        </div>

        <div class="pricing-insight">
          <h4>ğŸ’¡ Pricing Insight</h4>
          <p>{{eventPricing.reason}}</p>
          <div class="peak-event" *ngIf="eventPricing.peak_event_date">
            <strong>Peak Event Date:</strong> {{eventPricing.peak_event_date | date:'mediumDate'}}
          </div>
        </div>
      </div>

      <!-- Local Events Display -->
      <div class="events-section" *ngIf="cityEvents && !loadingEvents">
        <div class="section-header">
          <h3>ğŸª Local Events ({{cityEvents.total_events}})</h3>
          <button class="refresh-btn" (click)="loadCityEvents()" [disabled]="loadingEvents">
            {{loadingEvents ? 'Loading...' : 'Refresh Events'}}
          </button>
        </div>

        <div class="events-grid" *ngIf="cityEvents.events.length > 0">
          <div class="event-card" *ngFor="let event of cityEvents.events">
            <div class="event-header">
              <h4>{{event.name}}</h4>
              <span class="impact-badge" [style.background-color]="getImpactLevelColor(event.impact_level)">
                {{event.impact_level | titlecase}}
              </span>
            </div>
            <div class="event-details">
              <div class="detail">
                <span class="icon">ğŸ“…</span>
                <span>{{event.date | date:'short'}}</span>
              </div>
              <div class="detail">
                <span class="icon">ğŸ“</span>
                <span>{{event.venue}}</span>
              </div>
              <div class="detail">
                <span class="icon">ğŸ­</span>
                <span>{{event.category}}</span>
              </div>
              <div class="detail">
                <span class="icon">ğŸ‘¥</span>
                <span>{{event.expected_attendance | number}} attendees</span>
              </div>
            </div>
          </div>
        </div>

        <div class="no-events" *ngIf="cityEvents.events.length === 0">
          <p>No major events found for the selected dates in {{eventPricingForm.city}}.</p>
        </div>
      </div>
    </section>

    <!-- Smart Campaigns Section -->
    <section class="campaigns-section" *ngIf="activeTab === 'campaigns'">
      <div class="divider"></div>
      <h2>ğŸ“¢ Smart Campaigns</h2>
      <p class="subtitle">Reach high-potential travelers with AI-driven email offers</p>

      <div class="campaign-dashboard">
        <!-- Audience Insight -->
        <div class="audience-card" *ngIf="campaignStats">
          <h3>ğŸ¯ Audience Insight: {{campaignStats.criteria}}</h3>
          <div class="metric-row">
            <div class="metric">
              <span class="value">{{campaignStats.audience_count}}</span>
              <span class="label">Eligible Travelers</span>
            </div>
            <div class="metric">
              <span class="value">${{campaignStats.potential_revenue | number}}</span>
              <span class="label">Potential Revenue</span>
            </div>
            <div class="metric">
              <span class="value">{{campaignStats.segments.join(', ')}}</span>
              <span class="label">Target Segments</span>
            </div>
          </div>
          <button class="primary-btn" (click)="loadAudience()" [disabled]="loadingCampaign">
            {{loadingCampaign ? 'Refreshing...' : 'ğŸ”„ Refresh Audience'}}
          </button>
        </div>

        <!-- Campaign Creator -->
        <div class="campaign-creator" *ngIf="campaignStats && campaignStats.audience_count > 0">
          <h3>âœ‰ï¸ Create Q2 Offer</h3>

          <div class="generated-offer-preview" *ngIf="campaignOffer">
            <div class="offer-header">
              <span class="icon">âœ¨</span>
              <h4>{{campaignOffer.offer_name}}</h4>
            </div>
            <p class="offer-body">{{campaignOffer.copy}}</p>
          </div>

          <div class="action-buttons">
            <button class="secondary-btn" (click)="generateCampaignOffer()" [disabled]="loadingOffer">
              {{loadingOffer ? 'Generating...' : 'âœ¨ AI: Generate Offer Copy'}}
            </button>

            <button class="primary-btn pulse" (click)="sendCampaign()" [disabled]="!campaignOffer || sendingCampaign"
              *ngIf="campaignOffer">
              {{sendingCampaign ? 'Sending...' : 'ğŸš€ Send Campaign to ' + campaignStats.audience_count + ' Users'}}
            </button>
          </div>

          <div class="success-message" *ngIf="campaignResult">
            âœ… {{campaignResult.sent_count}} emails sent successfully!
          </div>
        </div>
      </div>
    </section>
  </main>
</div>